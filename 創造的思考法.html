<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰µé€ çš„æ€è€ƒæ³•ï¼”ç­</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f0f0f0;
            color: #333;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Mobile browser friendly */
            overflow: hidden;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* [NEW] ãƒ˜ãƒƒãƒ€ãƒ¼ */
        #header {
            height: 50px;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            flex-shrink: 0;
            z-index: 50;
        }
        #header-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        /* [MOD] ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ãƒƒãƒ‘ãƒ¼ */
        #content-wrapper {
            flex-grow: 1;
            overflow: hidden;
            position: relative; 
            background-color: #d0d0d0; /* ãƒ¡ã‚¤ãƒ³ã®èƒŒæ™¯è‰² */
        }
        
        /* [NEW] ãƒšãƒ¼ã‚¸å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .page-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
        }

        /* [MOD] ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®šã‚’å¤§å¹…æ”¹è‰¯ */
        #home-page {
            /* ãƒ¢ãƒã‚¤ãƒ«: ç¸¦ä¸¦ã³ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ */
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            padding-bottom: 80px; /* ãƒŠãƒ“ãƒãƒ¼ã®è£ã«éš ã‚Œãªã„ã‚ˆã†ã«ä½™ç™½ */
        }
        
        #top-left-wrapper {
            /* ãƒ¢ãƒã‚¤ãƒ«: 3Dã‚­ãƒ£ãƒ³ãƒã‚¹ã®é«˜ã•ã‚’ç¢ºä¿ */
            width: 100%;
            height: 40vh; 
            min-height: 300px;
            flex-shrink: 0;
        }

        #top-right-wrapper {
            /* ãƒ¢ãƒã‚¤ãƒ«: å†…å®¹ã«å¿œã˜ã¦é«˜ã•ç¢ºä¿ */
            width: 100%;
            flex-shrink: 0;
        }

        /* PC: æ¨ªä¸¦ã³ Gridãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        @media (min-width: 768px) {
            #home-page {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr; 
                gap: 20px;
                padding: 20px;
                padding-bottom: 20px;
                overflow: hidden; /* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã¯ãªãå„ãƒ‘ãƒãƒ«å†…ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            }
            
            #top-left-wrapper {
                height: 100%; /* ã‚°ãƒªãƒƒãƒ‰ã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
                min-height: auto;
            }
            
            #top-right-wrapper {
                height: 100%;
                overflow-y: auto;
            }
        }
        
        /* [NEW] ãƒ„ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ */
        #tools-page {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
        }


        .grid-panel {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .page-hidden {
            display: none !important;
        }

        /* --- 3Dã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        #top-left-wrapper {
        }
        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }
        #info {
           display: none;
        }
        #cctv-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 15;
            display: flex;
            align-items: center;
            gap: 8px; 
        }
        #rec-icon {
            width: 50px;
            height: 22px;
            background-color: red;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-align: center;
            line-height: 22px;
            animation: blink 1.5s infinite;
        }
        #cctv-label {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            background: rgba(255,255,255,0.7);
            padding: 2px 5px;
            border-radius: 4px;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        #timestamp {
            font-family: 'Courier New', Courier, monospace;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            background: rgba(255,255,255,0.7);
            padding: 2px 5px;
            border-radius: 4px;
        }

        /* --- åº§å¸­è¡¨ --- */
        #top-right-wrapper {
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        #top-right-wrapper h2 {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 10px 0; /* [MOD] margin-bottom */
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        /* [NEW] éƒ¨å±‹åˆ‡ã‚Šæ›¿ãˆã‚»ãƒ¬ã‚¯ã‚¿ */
        #room-selector-wrapper {
            margin-bottom: 15px;
            text-align: center;
        }
        #room-selector {
            font-size: 16px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #ddd;
            background-color: #f9f9f9;
        }

        #seating-chart {
            display: grid;
            /* [MOD] JSã§å‹•çš„ã«è¨­å®šã™ã‚‹ãŸã‚å‰Šé™¤ */
            /* grid-template-columns: repeat(3, 1fr); */
            gap: 15px;
            padding: 10px;
        }
        .seat {
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            border: 2px solid;
            transition: all 0.3s ease;
        }
        .seat.empty {
            background-color: #28a745;
            border-color: #34c759;
            color: white;
        }
        .seat.occupied {
            background-color: #dc3545;
            border-color: #ff453a;
            color: white;
        }
        .seat-placeholder {
            visibility: hidden;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* --- ç”»åƒåˆ†æã‚¢ãƒ—ãƒª --- */
        #bottom-left-wrapper {
            padding: 0; 
            box-sizing: border-box;
            display: block; 
            color: initial;
            font-style: normal;
            background-color: #f0f0f0; 
            overflow-y: auto; 
            height: 100%; 
        }
        
        @keyframes analyzer-spin {
            to { transform: rotate(360deg); }
        }
        .analyzer-spinner {
            animation: analyzer-spin 1s linear infinite;
            border-color: rgba(255, 255, 255, 0.3);
            border-top-color: white;
        }

        /* --- æ“ä½œãƒ‘ãƒãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ --- */
        #control-overlay {
            position: absolute;
            bottom: 15px; 
            left: 15px; 
            right: 15px; 
            z-index: 20;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px); 
            border-radius: 8px; 
            padding: 6px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; 
        }
        
        #controls {
            display: flex;
            flex-direction: row; 
            justify-content: space-around; 
            gap: 6px; 
            width: 100%; 
        }
        #controls button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 12px; 
            font-size: 12px; 
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            border-radius: 6px; 
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
            transition: all 0.3s ease;
            flex-grow: 1; 
        }
        #controls button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        #controls button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
        }
        
        /* --- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ --- */
        #navbar {
            width: 100%;
            height: 60px;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            flex-shrink: 0; 
        }
        #navbar button {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px 10px; /* [MOD] å·¦å³ã®paddingã‚’ç¸®å° */
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            flex-grow: 1;
        }
        #navbar button:hover {
            background-color: #f0f0f0;
        }
        #navbar button.active {
            color: #007bff;
            background-color: #e6f2ff;
        }
        #navbar button svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        /* --- ã‚ªã‚»ãƒ­ã‚²ãƒ¼ãƒ  --- */
        #game-page-wrapper {
            background-color: #1f2735; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            padding-bottom: 80px; /* ãƒŠãƒ“ãƒãƒ¼å¯¾å¿œ */
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: manipulation;
        }
        
        #game-page-wrapper .othello-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            background-color: #059669; 
            border: 4px solid #064e3b;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            aspect-ratio: 1/1;
        }
        #game-page-wrapper .othello-square {
            background-color: #10b981; 
            border: 1px solid #065f46;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        #game-page-wrapper .othello-disc {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            transition: transform 0.4s, background-color 0.4s;
            transform-style: preserve-3d;
        }
        #game-page-wrapper .othello-disc-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        #game-page-wrapper .othello-disc-front { /* Black */
            background-color: #1f2937;
        }
        #game-page-wrapper .othello-disc-back { /* White */
            background-color: #f9fafb;
            transform: rotateY(180deg);
        }
        #game-page-wrapper .othello-disc.black { transform: rotateY(0deg); }
        #game-page-wrapper .othello-disc.white { transform: rotateY(180deg); }
        
        #game-page-wrapper .othello-valid-move-indicator {
            width: 40%;
            height: 40%;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transition: opacity 0.2s;
        }
        #game-page-wrapper .othello-square:hover .othello-valid-move-indicator {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        /* [NEW] äºˆç´„ãƒšãƒ¼ã‚¸ */
        #reserve-page {
            background-color: #f0f0f0;
            padding: 20px;
            padding-bottom: 80px; /* ãƒŠãƒ“ãƒãƒ¼å¯¾å¿œ */
        }
        #reservation-form {
            max-width: 600px;
            margin: 20px auto;
            padding: 24px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #reservation-form h2 {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 24px;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 500;
            color: #555;
        }
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; /* paddingãŒå¹…ã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã« */
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: #007bff;
            outline: none;
        }
        #reserve-button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #reserve-button:hover {
            background-color: #0056b3;
        }

        /* --- [NEW] ã‚²ãƒ¼ãƒ é¸æŠãƒšãƒ¼ã‚¸ --- */
        #game-selection-page {
            background-color: #f3f4f6;
            overflow-y: auto;
            padding-bottom: 80px; /* ãƒŠãƒ“ãƒãƒ¼å¯¾å¿œ */
        }
        .game-select-button {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .game-select-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #007bff;
        }

        /* --- [NEW] ã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ  --- */
        #janken-page-wrapper {
             /* page-contentå…±é€šã‚¹ã‚¿ã‚¤ãƒ«ãŒé©ç”¨ã•ã‚Œã‚‹ */
             position: relative; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åŸºæº–ã«ã™ã‚‹ */
             overflow: hidden; /* ç´™å¹é›ªãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã« */
             padding-bottom: 80px; /* ãƒŠãƒ“ãƒãƒ¼å¯¾å¿œ */
        }
        .janken-button {
            font-size: 3rem; /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘: 48px */
            line-height: 1;
            padding: 1rem; /* 16px */
            border-radius: 50%;
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .janken-button:hover {
            background-color: #e0e0e0;
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .janken-button:active {
            transform: scale(1.05);
        }
        @media (min-width: 768px) {
            .janken-button {
                font-size: 4rem;
                padding: 1.5rem;
            }
        }

        #janken-result.win {
            color: #dc3545; /* èµ¤ */
        }
        #janken-result.lose {
            color: #007bff; /* é’ */
        }
        #janken-result.draw {
            color: #333; /* é»’ */
        }

        /* [NEW] ã˜ã‚ƒã‚“ã‘ã‚“ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡º */
        #janken-ai-hand.roulette {
            animation: janken-roulette 0.1s linear infinite;
        }
        @keyframes janken-roulette {
            0%   { transform: translateY(-5px) scale(1.05); opacity: 0.8; }
            50%  { transform: translateY(5px) scale(0.95); opacity: 1; }
            100% { transform: translateY(-5px) scale(1.05); opacity: 0.8; }
        }

        /* [NEW] ã‚¯ãƒ¼ãƒãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #janken-coupon-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #janken-coupon-modal:not(.page-hidden) {
            opacity: 1;
        }
        .coupon-content {
            background: linear-gradient(135deg, #ffecb3 0%, #ffe082 100%);
            border: 4px dashed #f57f17;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
         #janken-coupon-modal:not(.page-hidden) .coupon-content {
            transform: scale(1);
         }

        .coupon-title {
            font-size: 32px;
            font-weight: 700;
            color: #d84315;
            margin: 0;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .coupon-code {
            font-size: 48px;
            font-weight: 700;
            color: #c62828;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: inline-block;
            border: 2px solid #e64a19;
        }
        #janken-coupon-close-button {
            background-color: #f57f17;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #janken-coupon-close-button:hover {
            background-color: #e65100;
        }

        /* [NEW] ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            animation: confetti-fall 3s linear infinite;
        }
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotateZ(360deg);
                opacity: 0;
            }
        }
        
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body>
    <div id="header">
        <h1 id="header-title">ãƒ›ãƒ¼ãƒ </h1>
    </div>

    <div id="content-wrapper">
        
        <div id="home-page" class="page-content">
            
            <div id="top-left-wrapper" class="grid-panel">
                <div id="canvas-container">
                    <div id="cctv-overlay">
                        <div id="rec-icon">REC</div>
                        <div id="cctv-label">ã‚«ãƒ¡ãƒ©</div> 
                        <div id="timestamp"></div>
                    </div>
                </div>
                
                <div id="control-overlay">
                    <div id="controls">
                        <button id="startButton">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</button>
                        <button id="resetButton" style="background-color: #dc3545;">ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                </div>
            </div>

            <div id="top-right-wrapper" class="grid-panel">
                <h2>åº§å¸­è¡¨ãƒ¢ãƒ‹ã‚¿ãƒ¼</h2>
                <!-- [NEW] éƒ¨å±‹åˆ‡ã‚Šæ›¿ãˆã‚»ãƒ¬ã‚¯ã‚¿ -->
                <div id="room-selector-wrapper">
                    <select id="room-selector"></select>
                </div>
                
                <div id="seating-chart">
                    <!-- JavaScriptã«ã‚ˆã£ã¦å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #28a745;"></div>
                        <span>ç©ºå¸­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #dc3545;"></div>
                        <span>æº€å¸­</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tools-page" class="page-content page-hidden">
            <div id="bottom-left-wrapper" class="grid-panel">
                <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 w-full max-w-2xl mx-auto my-4">
                    
                    <header class="text-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">ç”»åƒåº§å¸­åˆ†æã‚¢ãƒ—ãƒª</h1>
                        <p class="text-gray-600 mt-2">Gemini API (JSONãƒ¢ãƒ¼ãƒ‰) ã«ã‚ˆã‚‹é«˜ç²¾åº¦åˆ†æ</p>
                    </header>

                    <main>
                        <div id="analyzer-uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-purple-500 hover:bg-purple-50 transition-all duration-300">
                            <input type="file" id="analyzer-imageUpload" class="hidden" accept="image/png, image/jpeg, image/webp">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                            </svg>
                            <p class="font-semibold text-gray-700">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ</p>
                            <p class="text-sm text-gray-500 mt-1">ã¾ãŸã¯ã€ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                            <!-- [NEW] ã‚µãƒ³ãƒ—ãƒ«ç”»åƒãƒœã‚¿ãƒ³ -->
                            <div class="mt-4 text-sm text-gray-500">
                                ã¾ãŸã¯ <button id="use-sample-image" class="text-purple-600 hover:text-purple-800 font-semibold underline focus:outline-none">ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã§è©¦ã™</button>
                            </div>
                        </div>
                        <div id="analyzer-imagePreviewContainer" class="hidden mt-6 text-center">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                            <img id="analyzer-imagePreview" src="" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ" class="max-w-full max-h-64 mx-auto rounded-lg shadow-md object-contain">
                            <div class="mt-4 flex flex-col">
                                <button id="analyzer-seatButton" class="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="buttonText">åº§å¸­ã‚’åˆ†æ</span>
                                    <div class="buttonSpinner hidden analyzer-spinner w-5 h-5 border-2 border-t-2 rounded-full mx-auto"></div>
                                </button>
                            </div>
                            <button id="analyzer-resetButton" class="mt-2 w-full bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition-all duration-300 disabled:opacity-50">
                                åˆ¥ã®ç”»åƒã‚’è©¦ã™
                            </button>
                        </div>
                        <div id="analyzer-resultContainer" class="hidden mt-8">
                            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">åˆ†æçµæœ</h3>
                            <div id="analyzer-loadingIndicator" class="hidden text-center p-4">
                                <p class="text-gray-600">åˆ†æä¸­ã§ã™...</p>
                            </div>
                            <div id="analyzer-errorDisplay" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                                <strong class="font-bold">ã‚¨ãƒ©ãƒ¼:</strong>
                                <span class="block sm:inline" id="analyzer-errorMessage"></span>
                            </div>
                            <div id="analyzer-resultDisplay" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200 text-center">
                                    <p class="text-sm font-medium text-green-700">å æœ‰å¸­</p>
                                    <p id="analyzer-resultOccupied" class="text-4xl font-bold text-green-800">?</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 text-center">
                                    <p class="text-sm font-medium text-blue-700">ç©ºå¸­</p>
                                    <p id="analyzer-resultEmpty" class="text-4xl font-bold text-blue-800">?</p>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 text-center">
                                    <p class="text-sm font-medium text-purple-700">æ¤…å­ã®ç·æ•°</p>
                                    <p id="analyzer-resultTotal" class="text-4xl font-bold text-purple-800">?</p>
                                </div>
                            </div>
                            <div id="analyzer-rawJsonDisplayContainer" class="hidden mt-4">
                                <p class="text-xs text-gray-500">ãƒ‡ãƒãƒƒã‚°æƒ…å ± (ç”Ÿã®JSONå¿œç­”):</p>
                                <pre id="analyzer-rawJsonDisplay" class="bg-gray-800 text-white text-xs p-3 rounded-lg overflow-x-auto"></pre>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>
        
        <!-- [NEW] äºˆç´„ãƒšãƒ¼ã‚¸ -->
        <div id="reserve-page" class="page-content page-hidden">
             <div id="reservation-form">
                <h2>åº§å¸­ã®äºˆç´„</h2>
                <div class="form-group">
                    <label for="reserve-location">å ´æ‰€</label>
                    <select id="reserve-location"></select>
                </div>
                <div class="form-group">
                    <label for="reserve-date">æ—¥ä»˜</label>
                    <input type="date" id="reserve-date">
                </div>
                <div class="form-group">
                    <label for="reserve-time">æ™‚åˆ»</label>
                    <input type="time" id="reserve-time" step="900"> <!-- 15åˆ†å˜ä½ -->
                </div>
                <button id="reserve-button">äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
            </div>
        </div>

        <!-- [NEW] ã‚²ãƒ¼ãƒ é¸æŠãƒšãƒ¼ã‚¸ -->
        <div id="game-selection-page" class="page-content page-hidden">
            <div class="flex flex-col items-center justify-center h-full p-8">
                <h2 class="text-3xl font-bold mb-12 text-gray-700">ã©ã¡ã‚‰ã§éŠã³ã¾ã™ã‹ï¼Ÿ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-2xl">
                    <button id="select-game-othello" class="game-select-button">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5V12m0 0l-1-1m1 1l-1 1m1-1H3m5.25 0H18M9 12l1-1m-1 1l1 1m0 0H21m-12 0H9.75M9 15l-1-1m1 1l-1 1m1-1H3m5.25 0H18M9 15l1-1m-1 1l1 1m0 0H21m-12 0H9.75M9 19.5V12m0 0l-1-1m1 1l-1 1m1-1H3m5.25 0H18M9 12l1-1m-1 1l1 1m0 0H21m-12 0H9.75" />
                        </svg>
                        <span class="text-2xl font-bold">AIå¯¾æˆ¦ã‚ªã‚»ãƒ­</span>
                        <p class="mt-2 text-gray-600">æ‰‹å¼·ã„AIã¨å¯¾æˆ¦ã—ã‚ˆã†</p>
                    </button>
                    <button id="select-game-janken" class="game-select-button">
                          <svg class="w-16 h-16 mx-auto mb-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.31h5.418a.562.562 0 01.321.988l-4.204 3.192a.563.563 0 00-.182.53l1.53 5.3a.562.562 0 01-.84.622l-4.28-3.149a.563.563 0 00-.652 0l-4.28 3.149a.562.562 0 01-.84-.622l1.53-5.3a.563.563 0 00-.182-.53L2.51 9.908a.562.562 0 01.321-.988h5.418a.563.563 0 00.475-.31L11.48 3.5z" />
                            <path d="M18.375 12.75H5.625" />
                          </svg>
                        <span class="text-2xl font-bold">ã˜ã‚ƒã‚“ã‘ã‚“</span>
                        <p class="mt-2 text-gray-600">ã‚·ãƒ³ãƒ—ãƒ«ãªé‹è©¦ã—</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- ã‚ªã‚»ãƒ­ã‚²ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ (æœ€åˆã¯éè¡¨ç¤º) -->
        <div id="game-page-wrapper" class="page-content page-hidden">
            <div class="w-full max-w-lg mx-auto">
                <h1 class="text-3xl md:text-4xl font-bold text-center text-white mb-4">AIå¯¾æˆ¦ã‚ªã‚»ãƒ­</h1>
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-t-lg text-white">
                    <div class="text-center">
                        <div class="text-lg font-bold">ã‚ãªãŸ (é»’)</div>
                        <div id="othello-player-score" class="text-2xl font-bold">2</div>
                    </div>
                    <div id="othello-turn-indicator" class="text-lg font-semibold px-4 py-2 rounded-md bg-blue-500">ã‚ãªãŸã®ç•ª</div>
                    <div class="text-center">
                        <div class="text-lg font-bold">AI (ç™½)</div>
                        <div id="othello-ai-score" class="text-2xl font-bold">2</div>
                    </div>
                </div>
                <div id="othello-board" class="othello-board"></div>
                <div class="text-center mt-4">
                    <button id="othello-reset-button" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition-colors">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
        
        <!-- [NEW] ã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ (æœ€åˆã¯éè¡¨ç¤º) -->
        <div id="janken-page-wrapper" class="page-content page-hidden">
             <div class="flex flex-col items-center justify-center h-full bg-gray-100 p-4">
                <h1 class="text-4xl font-bold text-gray-800 mb-8">ã˜ã‚ƒã‚“ã‘ã‚“</h1>
                
                <div class="bg-white p-8 rounded-2xl shadow-xl text-center min-w-[300px] md:min-w-[450px]">
                    <p class="text-xl text-gray-600 mb-4">ã‚ãªãŸã®æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                    
                    <div class="flex justify-center gap-4 md:gap-8 mb-8">
                        <button id="janken-rock" class="janken-button">âœŠ</button>
                        <button id="janken-scissors" class="janken-button">âœŒï¸</button>
                        <button id="janken-paper" class="janken-button">âœ‹</button>
                    </div>
                    
                    <div class="text-2xl font-bold mb-4 min-h-[100px]">
                        <p class="mb-2">AIã®æ‰‹: <span id="janken-ai-hand" class="text-5xl">?</span></p>
                        <p id="janken-result" class="text-3xl md:text-4xl">&nbsp;</p>
                    </div>
                </div>
            </div>
            
            <!-- [NEW] ã‚¯ãƒ¼ãƒãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« (æœ€åˆã¯éè¡¨ç¤º) -->
            <div id="janken-coupon-modal" class="page-hidden">
                <!-- ç´™å¹é›ªã‚’å‹•çš„ã«è¿½åŠ ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
                <div id="confetti-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1;"></div>
                <div class="coupon-content" style="z-index: 2;">
                    <h2 class="coupon-title">ğŸ‰ ãŠã‚ã§ã¨ã†ï¼ ğŸ‰</h2>
                    <p class="text-xl font-medium text-gray-700 mt-4">å‹åˆ©ã—ã¾ã—ãŸï¼</p>
                    <p class="coupon-code">5% OFF</p>
                    <p class="text-lg font-medium text-gray-700">ã‚¯ãƒ¼ãƒãƒ³ã‚’ã‚²ãƒƒãƒˆï¼</p>
                    <button id="janken-coupon-close-button" class="mt-6">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>

    </div> <!-- END #content-wrapper -->

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <div id="navbar">
        <button id="nav-home">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-7-4h10" />
            </svg>
            <span>ãƒ›ãƒ¼ãƒ </span>
        </button>
        <button id="nav-tools">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.573-1.066z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span>ãƒ„ãƒ¼ãƒ«</span>
        </button>
        <!-- [NEW] äºˆç´„ãƒœã‚¿ãƒ³ -->
        <button id="nav-reserve">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            <span>äºˆç´„</span>
        </button>
        <button id="nav-game">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 12h.008v.008H6V12zm3 0h.008v.008H9V12zm3 0h.008v.008H12V12zm3 0h.008v.008H15V12z" />
            </svg>
            <span>æš‡ã¤ã¶ã—</span>
        </button>
    </div>


    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ --><script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.166.1/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.166.1/examples/jsm/",
                "@tweenjs/tween.js": "https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@23.1.1/dist/tween.esm.js"
            }
        }
    </script>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ1: ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ & ãƒšãƒ¼ã‚¸ç®¡ç† -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import TWEEN from '@tweenjs/tween.js';

        let scene, camera, renderer, controls, clock;
        let ambientLight, ground; // [NEW] éƒ¨å±‹åˆ‡ã‚Šæ›¿ãˆã§å‰Šé™¤ã—ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        
        let allCustomers = [];
        let customerQueue = [];
        let simulationState = 'IDLE';
        let lastAssignmentTime = 0;
        
        const container = document.getElementById('canvas-container');
        const chartContainer = document.getElementById('seating-chart');
        const roomSelector = document.getElementById('room-selector'); // [NEW]

        // [MOD] ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆç”¨DOM
        const headerTitle = document.getElementById('header-title');
        const navHomeButton = document.getElementById('nav-home');
        const navToolsButton = document.getElementById('nav-tools');
        const navGameButton = document.getElementById('nav-game'); 
        const navReserveButton = document.getElementById('nav-reserve'); // [NEW]
        
        const homePage = document.getElementById('home-page');
        const toolsPage = document.getElementById('tools-page');
        const gamePage = document.getElementById('game-page-wrapper'); // ã‚ªã‚»ãƒ­ãƒšãƒ¼ã‚¸
        const reservePage = document.getElementById('reserve-page'); // [NEW]

        // [NEW] ã‚²ãƒ¼ãƒ é–¢é€£ãƒšãƒ¼ã‚¸
        const gameSelectionPage = document.getElementById('game-selection-page');
        const jankenPage = document.getElementById('janken-page-wrapper');
        const selectOthelloButton = document.getElementById('select-game-othello');
        const selectJankenButton = document.getElementById('select-game-janken');
        
        // [NEW] äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ç”¨DOM
        const reserveLocationSelect = document.getElementById('reserve-location');
        const reserveDateInput = document.getElementById('reserve-date');
        const reserveTimeInput = document.getElementById('reserve-time');
        const reserveButton = document.getElementById('reserve-button');

        // --- [NEW] è¤‡æ•°ãƒ«ãƒ¼ãƒ å¯¾å¿œ ---
        const FLOOR_Y = -1.0;
        const CHAIR_SCALE = 1.2;
        const DESK_SCALE = 1.5;
        
        // [FIX] ä¸è¶³ã—ã¦ã„ãŸå®šæ•°ã‚’è¿½åŠ 
        const ASSIGNMENT_INTERVAL_BASE = 5000; // 5ç§’ãƒ™ãƒ¼ã‚¹
        const ASSIGNMENT_INTERVAL_RANDOM = 5000; // + 0ã€œ5ç§’ (åˆè¨ˆ5ã€œ10ç§’)
        const EXIT_POINT = new THREE.Vector3(-10, FLOOR_Y, 0); // é¡§å®¢ã‚¯ãƒ©ã‚¹ã§ä½¿ç”¨

        let currentRoomId = 'main_hall'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®éƒ¨å±‹
        let sceneObjects = { // [NEW] éƒ¨å±‹ã”ã¨ã«å‰Šé™¤ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†
            desks: [],
            chairs: [],
            lights: [],
            cameras: []
        };
        
        // [NEW] éƒ¨å±‹ã”ã¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€åº§å¸­è¡¨ã€å¾…æ©Ÿåˆ—ã®å®šç¾©
        const ROOM_DATA = {
            'main_hall': {
                name: 'ã‚°ãƒ©ãƒ³äº­',
                num_queue_robots: 6,
                queue_start: new THREE.Vector3(8, FLOOR_Y, -2),
                queue_spacing: -1.5,
                chart_grid: [2, 0, 1, 6, -1, 7, 5, 3, 4],
                chart_columns: 3,
                seats: [
                    { id: 0, desk: new THREE.Vector3(0, FLOOR_Y, -4), chair: new THREE.Vector3(0, FLOOR_Y, -3), sitPoint: new THREE.Vector3(0, FLOOR_Y + 0.6, -3.8), walkTo: new THREE.Vector3(0, FLOOR_Y, -2.0), rotation: Math.PI },
                    { id: 1, desk: new THREE.Vector3(3, FLOOR_Y, -4), chair: new THREE.Vector3(3, FLOOR_Y, -3), sitPoint: new THREE.Vector3(3, FLOOR_Y + 0.6, -3.8), walkTo: new THREE.Vector3(3, FLOOR_Y, -2.0), rotation: Math.PI },
                    { id: 2, desk: new THREE.Vector3(-3, FLOOR_Y, -4), chair: new THREE.Vector3(-3, FLOOR_Y, -3), sitPoint: new THREE.Vector3(-3, FLOOR_Y + 0.6, -3.8), walkTo: new THREE.Vector3(-3, FLOOR_Y, -2.0), rotation: Math.PI },
                    { id: 3, desk: new THREE.Vector3(0, FLOOR_Y, 4), chair: new THREE.Vector3(0, FLOOR_Y, 3), sitPoint: new THREE.Vector3(0, FLOOR_Y + 0.6, 3.8), walkTo: new THREE.Vector3(0, FLOOR_Y, 2.0), rotation: 0 },
                    { id: 4, desk: new THREE.Vector3(3, FLOOR_Y, 4), chair: new THREE.Vector3(3, FLOOR_Y, 3), sitPoint: new THREE.Vector3(3, FLOOR_Y + 0.6, 3.8), walkTo: new THREE.Vector3(3, FLOOR_Y, 2.0), rotation: 0 },
                    { id: 5, desk: new THREE.Vector3(-3, FLOOR_Y, 4), chair: new THREE.Vector3(-3, FLOOR_Y, 3), sitPoint: new THREE.Vector3(-3, FLOOR_Y + 0.6, 3.8), walkTo: new THREE.Vector3(-3, FLOOR_Y, 2.0), rotation: 0 },
                    { id: 6, desk: new THREE.Vector3(-6, FLOOR_Y, 0), chair: new THREE.Vector3(-5, FLOOR_Y, 0), sitPoint: new THREE.Vector3(-5.8, FLOOR_Y + 0.6, 0), walkTo: new THREE.Vector3(-4.0, FLOOR_Y, 0), rotation: Math.PI / 2 },
                    { id: 7, desk: new THREE.Vector3(6, FLOOR_Y, 0), chair: new THREE.Vector3(5, FLOOR_Y, 0), sitPoint: new THREE.Vector3(5.8, FLOOR_Y + 0.6, 0), walkTo: new THREE.Vector3(4.0, FLOOR_Y, 0), rotation: -Math.PI / 2 }
                ],
                lights: [
                    { x: 0, z: -4 }, { x: 3, z: -4 }, { x: -3, z: -4 },
                    { x: 0, z: 4 }, { x: 3, z: 4 }, { x: -3, z: 4 },
                    { x: -6, z: 0 }, { x: 6, z: 0 }
                ],
                cameras: [
                    { x: 7, y: 7, z: 7 }, { x: -7, y: 7, z: 7 },
                    { x: 7, y: 7, z: -7 }, { x: -7, y: 7, z: -7 }
                ]
            },
            'terrace': {
                name: 'ååŸé£Ÿå ‚',
                num_queue_robots: 4,
                queue_start: new THREE.Vector3(6, FLOOR_Y, 5),
                queue_spacing: -1.5,
                chart_grid: [0, 1, -1, 2, 3],
                chart_columns: 2,
                seats: [
                    { id: 0, desk: new THREE.Vector3(-3, FLOOR_Y, 0), chair: new THREE.Vector3(-3, FLOOR_Y, 1), sitPoint: new THREE.Vector3(-3, FLOOR_Y + 0.6, 0.2), walkTo: new THREE.Vector3(-3, FLOOR_Y, 2.0), rotation: Math.PI },
                    { id: 1, desk: new THREE.Vector3(3, FLOOR_Y, 0), chair: new THREE.Vector3(3, FLOOR_Y, 1), sitPoint: new THREE.Vector3(3, FLOOR_Y + 0.6, 0.2), walkTo: new THREE.Vector3(3, FLOOR_Y, 2.0), rotation: Math.PI },
                    { id: 2, desk: new THREE.Vector3(-3, FLOOR_Y, -5), chair: new THREE.Vector3(-3, FLOOR_Y, -4), sitPoint: new THREE.Vector3(-3, FLOOR_Y + 0.6, -4.8), walkTo: new THREE.Vector3(-3, FLOOR_Y, -3.0), rotation: Math.PI },
                    { id: 3, desk: new THREE.Vector3(3, FLOOR_Y, -5), chair: new THREE.Vector3(3, FLOOR_Y, -4), sitPoint: new THREE.Vector3(3, FLOOR_Y + 0.6, -4.8), walkTo: new THREE.Vector3(3, FLOOR_Y, -3.0), rotation: Math.PI }
                ],
                lights: [
                    { x: -3, z: 0 }, { x: 3, z: 0 }, { x: -3, z: -5 }, { x: 3, z: -5 }
                ],
                cameras: [
                    { x: 5, y: 7, z: 5 }, { x: -5, y: 7, z: -5 }
                ]
            },
            'private_room': {
                name: 'ç©ºãæ•™å®¤',
                num_queue_robots: 2,
                queue_start: new THREE.Vector3(5, FLOOR_Y, 0),
                queue_spacing: -1.5,
                chart_grid: [-1, 0, -1, -1, 1, -1],
                chart_columns: 3,
                seats: [
                    { id: 0, desk: new THREE.Vector3(0, FLOOR_Y, 0), chair: new THREE.Vector3(0, FLOOR_Y, 1), sitPoint: new THREE.Vector3(0, FLOOR_Y + 0.6, 0.2), walkTo: new THREE.Vector3(0, FLOOR_Y, 2.0), rotation: Math.PI },
                    { id: 1, desk: new THREE.Vector3(0, FLOOR_Y, -5), chair: new THREE.Vector3(0, FLOOR_Y, -4), sitPoint: new THREE.Vector3(0, FLOOR_Y + 0.6, -4.8), walkTo: new THREE.Vector3(0, FLOOR_Y, -3.0), rotation: Math.PI }
                ],
                lights: [
                    { x: 0, z: 0 }, { x: 0, z: -5 }
                ],
                cameras: [
                    { x: 0, y: 7, z: 0 }
                ]
            }
        };

        // [NEW] éƒ¨å±‹ã”ã¨ã®ç©ºå¸­çŠ¶æ…‹
        let roomAvailableSeats = {};
        Object.keys(ROOM_DATA).forEach(roomId => {
            roomAvailableSeats[roomId] = Array(ROOM_DATA[roomId].seats.length).fill(true);
        });
        
        // --- [MOD] ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆé–¢æ•° ---
        function showHomePage() {
            headerTitle.textContent = 'ãƒ›ãƒ¼ãƒ ';
            homePage.classList.remove('page-hidden');
            toolsPage.classList.add('page-hidden');
            gamePage.classList.add('page-hidden');
            reservePage.classList.add('page-hidden');
            gameSelectionPage.classList.add('page-hidden'); // [NEW]
            jankenPage.classList.add('page-hidden'); // [NEW]
            
            navHomeButton.classList.add('active');
            navToolsButton.classList.remove('active');
            navGameButton.classList.remove('active');
            navReserveButton.classList.remove('active');
            
            setTimeout(onWindowResize, 50); 
        }

        function showToolsPage() {
            headerTitle.textContent = 'ãƒ„ãƒ¼ãƒ«';
            homePage.classList.add('page-hidden');
            toolsPage.classList.remove('page-hidden');
            gamePage.classList.add('page-hidden');
            reservePage.classList.add('page-hidden');
            gameSelectionPage.classList.add('page-hidden'); // [NEW]
            jankenPage.classList.add('page-hidden'); // [NEW]

            navHomeButton.classList.remove('active');
            navToolsButton.classList.add('active');
            navGameButton.classList.remove('active');
            navReserveButton.classList.remove('active');
        }

        function showGamePage() {
            headerTitle.textContent = 'æš‡ã¤ã¶ã—';
            homePage.classList.add('page-hidden');
            toolsPage.classList.add('page-hidden');
            gamePage.classList.add('page-hidden'); // ã‚ªã‚»ãƒ­ã‚‚éè¡¨ç¤º
            reservePage.classList.add('page-hidden');
            jankenPage.classList.add('page-hidden'); // ã˜ã‚ƒã‚“ã‘ã‚“ã‚‚éè¡¨ç¤º
            gameSelectionPage.classList.remove('page-hidden'); // [MOD] é¸æŠç”»é¢ã‚’è¡¨ç¤º
            
            navHomeButton.classList.remove('active');
            navToolsButton.classList.remove('active');
            navGameButton.classList.add('active');
            navReserveButton.classList.remove('active');
        }

        function showReservePage() {
            headerTitle.textContent = 'äºˆç´„';
            homePage.classList.add('page-hidden');
            toolsPage.classList.add('page-hidden');
            gamePage.classList.add('page-hidden');
            reservePage.classList.remove('page-hidden');
            gameSelectionPage.classList.add('page-hidden'); // [NEW]
            jankenPage.classList.add('page-hidden'); // [NEW]
            
            navHomeButton.classList.remove('active');
            navToolsButton.classList.remove('active');
            navGameButton.classList.remove('active');
            navReserveButton.classList.add('active');
        }

        // [NEW] é¸æŠç”»é¢ã‹ã‚‰å„ã‚²ãƒ¼ãƒ ã¸ã®é·ç§»é–¢æ•°
        function showOthelloGame() {
            headerTitle.textContent = 'AIå¯¾æˆ¦ã‚ªã‚»ãƒ­'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚æ›´æ–°
            gameSelectionPage.classList.add('page-hidden');
            gamePage.classList.remove('page-hidden');
            jankenPage.classList.add('page-hidden');
        }

        function showJankenGame() {
            headerTitle.textContent = 'ã˜ã‚ƒã‚“ã‘ã‚“'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚æ›´æ–°
            gameSelectionPage.classList.add('page-hidden');
            gamePage.classList.add('page-hidden');
            jankenPage.classList.remove('page-hidden');
        }


        class Customer {
            // ... (Customer ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã—) ...
            constructor(scene) {
                this.scene = scene;
                this.robot = new THREE.Group();
                this.seatIndex = -1;
                this.state = 'IDLE'; 
                
                this.animationState = { torsoY: 0, thighRotX: 0, kneeRotX: 0 };
                this.currentTween = null;
                this.sitStartTime = 0; 
                this.sittingDuration = Math.random() * 10000 + 15000; 

                this.buildRobot();
            }
            buildRobot() {
                this.torso = new THREE.Group();
                this.robot.add(this.torso);
                const bodyMat = new THREE.MeshStandardMaterial({ color: 0x0000ff });
                const limbMat = new THREE.MeshStandardMaterial({ color: 0x888888 });
                const headMat = new THREE.MeshStandardMaterial({ color: 0xffcc00 });
                const eyeMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
                const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.2, 0.6), bodyMat);
                body.position.y = 1.6;
                body.castShadow = true;
                this.torso.add(body);
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.7, 0.7), headMat);
                head.position.y = 2.55;
                head.castShadow = true;
                this.torso.add(head);
                const eyeGeometry = new THREE.SphereGeometry(0.08, 16, 16);
                const eyeL = new THREE.Mesh(eyeGeometry, eyeMat);
                eyeL.position.set(-0.2, 2.6, 0.36);
                this.torso.add(eyeL);
                const eyeR = eyeL.clone();
                eyeR.position.set(0.2, 2.6, 0.36);
                this.torso.add(eyeR);
                const armGeom = new THREE.CylinderGeometry(0.15, 0.15, 0.8, 16);
                const armR = new THREE.Mesh(armGeom, limbMat);
                armR.position.set(-0.7, 1.8, 0);
                armR.castShadow = true;
                this.torso.add(armR);
                const armL = armR.clone();
                armL.position.set(0.7, 1.8, 0);
                this.torso.add(armL);
                const thighGeom = new THREE.CylinderGeometry(0.2, 0.2, 0.5, 16);
                const shinGeom = new THREE.CylinderGeometry(0.2, 0.2, 0.5, 16);
                const legR = new THREE.Group();
                legR.position.set(-0.3, 1.0, 0);
                this.thighR = new THREE.Mesh(thighGeom, limbMat);
                this.thighR.position.y = -0.25;
                this.thighR.castShadow = true;
                this.kneeR = new THREE.Group();
                this.kneeR.position.y = -0.5;
                const shinR = new THREE.Mesh(shinGeom, limbMat);
                shinR.position.y = -0.25;
                shinR.castShadow = true;
                this.kneeR.add(shinR);
                this.thighR.add(this.kneeR);
                legR.add(this.thighR);
                this.robot.add(legR);
                const legL = new THREE.Group();
                legL.position.set(0.3, 1.0, 0);
                this.thighL = new THREE.Mesh(thighGeom, limbMat);
                this.thighL.position.y = -0.25;
                this.thighL.castShadow = true;
                this.kneeL = new THREE.Group();
                this.kneeL.position.y = -0.5;
                const shinL = new THREE.Mesh(shinGeom, limbMat);
                shinL.position.y = -0.25;
                shinL.castShadow = true;
                this.kneeL.add(shinL);
                this.thighL.add(this.kneeL);
                legL.add(this.thighL);
                this.robot.add(legL);
                this.scene.add(this.robot);
            }
            spawnAtQueue(position) {
                this.robot.position.copy(position);
                this.robot.rotation.y = -Math.PI / 2;
                this.state = 'WAITING_IN_QUEUE';
                this.resetPose();
            }
            resetPose() {
                if (this.currentTween) this.currentTween.stop();
                this.animationState.torsoY = 0;
                this.animationState.thighRotX = 0;
                this.animationState.kneeRotX = 0;
                this.updateRobotPose();
                if(this.state !== 'WAITING_IN_QUEUE') this.state = 'IDLE';
            }
            _walkTo(targetPosition, targetRotationY, newState, callback) {
                this.state = 'WALKING';
                if (this.currentTween) this.currentTween.stop();
                const startRotationY = this.robot.rotation.y;
                const endRotationY = targetRotationY;
                const turnTween = new TWEEN.Tween({ y: startRotationY })
                    .to({ y: endRotationY }, 500)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate((obj) => { this.robot.rotation.y = obj.y; });
                const moveTween = new TWEEN.Tween(this.robot.position)
                    .to(targetPosition, 2000) 
                    .easing(TWEEN.Easing.Linear.None)
                    .onComplete(() => {
                        this.state = newState;
                        this.resetPose();
                        if (callback) callback();
                    });
                this.currentTween = turnTween;
                turnTween.chain(moveTween);
                turnTween.start();
            }
            walkToSeat(targetPosition, targetRotationY, callback) {
                this._walkTo(targetPosition, targetRotationY, 'IDLE', callback);
            }
            walkToExit(callback) {
                this._walkTo(EXIT_POINT, -Math.PI / 2, 'LEAVING', callback);
            }
            sitDown(sitPosition, callback) {
                this.state = 'SITTING_DOWN';
                if (this.currentTween) this.currentTween.stop();
                const moveTween = new TWEEN.Tween(this.robot.position)
                    .to(sitPosition, 500)
                    .easing(TWEEN.Easing.Quadratic.InOut);
                const sitTween = new TWEEN.Tween(this.animationState)
                    .to({
                        torsoY: -0.4,
                        thighRotX: Math.PI / 2.1,
                        kneeRotX: -Math.PI / 2.0
                    }, 1000)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate(() => this.updateRobotPose())
                    .onComplete(() => {
                        this.state = 'SITTING';
                        this.sitStartTime = clock.getElapsedTime() * 1000; 
                        if (callback) callback();
                    });
                this.currentTween = moveTween;
                moveTween.chain(sitTween);
                moveTween.start();
            }
            standUp(callback) {
                this.state = 'STANDING_UP';
                if (this.currentTween) this.currentTween.stop();
                const standTween = new TWEEN.Tween(this.animationState)
                    .to({ torsoY: 0, thighRotX: 0, kneeRotX: 0 }, 1000)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate(() => this.updateRobotPose())
                    .onComplete(() => {
                        this.state = 'IDLE'; 
                        if (callback) callback();
                    });
                this.currentTween = standTween;
                standTween.start();
            }
            update(elapsedTime) {
                if (this.state === 'WALKING' || this.state === 'LEAVING') {
                    const walkSpeed = elapsedTime * 8;
                    this.animationState.thighRotX = Math.sin(walkSpeed) * 0.5;
                    this.animationState.kneeRotX = Math.max(0, Math.sin(walkSpeed + Math.PI / 2) * 0.6);
                    this.thighL.rotation.x = this.animationState.thighRotX;
                    this.kneeL.rotation.x = this.animationState.kneeRotX;
                    this.thighR.rotation.x = -this.animationState.thighRotX;
                    this.kneeR.rotation.x = Math.max(0, Math.sin(walkSpeed + Math.PI / 2 + Math.PI) * 0.6);
                }
                if (this.state === 'SITTING') {
                    const elapsedTimeInMs = elapsedTime * 1000;
                    if (elapsedTimeInMs - this.sitStartTime >= this.sittingDuration) {
                        this.state = 'LEAVING_PREP'; 
                        this.standUp(() => {
                            this.walkToExit(() => {
                                this.state = 'REMOVABLE'; 
                                roomAvailableSeats[currentRoomId][this.seatIndex] = true; // [MOD]
                                updateSeatingChart();
                            });
                        });
                    }
                }
            }
            updateRobotPose() {
                this.torso.position.y = this.animationState.torsoY;
                this.thighL.rotation.x = this.animationState.thighRotX;
                this.thighR.rotation.x = this.animationState.thighRotX;
                this.kneeL.rotation.x = this.animationState.kneeRotX;
                this.kneeR.rotation.x = this.animationState.kneeRotX;
            }
            moveToQueuePosition(newPosition) {
                this.state = 'WAITING_IN_QUEUE';
                if (this.currentTween) this.currentTween.stop();
                this.currentTween = new TWEEN.Tween(this.robot.position)
                    .to(newPosition, 300)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .start();
            }
            remove() {
                this.scene.remove(this.robot);
                if (this.currentTween) this.currentTween.stop();
            }
        }

        function createChair(position, rotationY = 0) {
            const chair = new THREE.Group();
            const woodMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const seatGeometry = new THREE.BoxGeometry(0.6 * CHAIR_SCALE, 0.1 * CHAIR_SCALE, 0.6 * CHAIR_SCALE);
            const seat = new THREE.Mesh(seatGeometry, woodMaterial);
            seat.position.y = 0.5 * CHAIR_SCALE;
            seat.castShadow = true;
            chair.add(seat);
            const backGeometry = new THREE.BoxGeometry(0.6 * CHAIR_SCALE, 0.7 * CHAIR_SCALE, 0.08 * CHAIR_SCALE);
            const back = new THREE.Mesh(backGeometry, woodMaterial);
            back.position.set(0, (0.5 + 0.4) * CHAIR_SCALE, -0.26 * CHAIR_SCALE);
            back.castShadow = true;
            chair.add(back);
            const legGeometry = new THREE.BoxGeometry(0.08 * CHAIR_SCALE, 0.5 * CHAIR_SCALE, 0.08 * CHAIR_SCALE);
            const leg1 = new THREE.Mesh(legGeometry, woodMaterial);
            leg1.position.set(-0.25 * CHAIR_SCALE, 0.25 * CHAIR_SCALE, -0.25 * CHAIR_SCALE);
            leg1.castShadow = true;
            chair.add(leg1);
            const leg2 = leg1.clone();
            leg2.position.set(0.25 * CHAIR_SCALE, 0.25 * CHAIR_SCALE, -0.25 * CHAIR_SCALE);
            chair.add(leg2);
            const leg3 = leg1.clone();
            leg3.position.set(-0.25 * CHAIR_SCALE, 0.25 * CHAIR_SCALE, 0.25 * CHAIR_SCALE);
            chair.add(leg3);
            const leg4 = leg1.clone();
            leg4.position.set(0.25 * CHAIR_SCALE, 0.25 * CHAIR_SCALE, 0.25 * CHAIR_SCALE);
            chair.add(leg4);
            chair.position.copy(position);
            chair.rotation.y = rotationY;
            scene.add(chair);
            sceneObjects.chairs.push(chair); // [NEW] ç®¡ç†ãƒªã‚¹ãƒˆã«è¿½åŠ 
        }

        function createDesk(position, rotationY = 0) {
            const desk = new THREE.Group();
            const woodMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const topGeometry = new THREE.BoxGeometry(1.5 * DESK_SCALE, 0.1 * DESK_SCALE, 0.8 * DESK_SCALE);
            const top = new THREE.Mesh(topGeometry, woodMaterial);
            top.position.y = (0.8 + 0.05) * DESK_SCALE;
            top.castShadow = true;
            desk.add(top);
            const legGeometry = new THREE.BoxGeometry(0.1 * DESK_SCALE, 0.8 * DESK_SCALE, 0.1 * DESK_SCALE);
            const leg1 = new THREE.Mesh(legGeometry, woodMaterial);
            leg1.position.set(-0.65 * DESK_SCALE, 0.4 * DESK_SCALE, -0.3 * DESK_SCALE);
            leg1.castShadow = true;
            desk.add(leg1);
            const leg2 = leg1.clone();
            leg2.position.set(0.65 * DESK_SCALE, 0.4 * DESK_SCALE, -0.3 * DESK_SCALE);
            desk.add(leg2);
            const leg3 = leg1.clone();
            leg3.position.set(-0.65 * DESK_SCALE, 0.4 * DESK_SCALE, 0.3 * DESK_SCALE);
            desk.add(leg3);
            const leg4 = leg1.clone();
            leg4.position.set(0.65 * DESK_SCALE, 0.4 * DESK_SCALE, 0.3 * DESK_SCALE);
            desk.add(leg4);
            desk.position.copy(position);
            desk.rotation.y = rotationY;
            scene.add(desk);
            sceneObjects.desks.push(desk); // [NEW] ç®¡ç†ãƒªã‚¹ãƒˆã«è¿½åŠ 
        }

        function createSecurityCamera(position) {
            const cameraGroup = new THREE.Group();
            const cameraMat = new THREE.MeshStandardMaterial({ color: 0x222222 }); 
            const baseGeom = new THREE.CylinderGeometry(0.6, 0.6, 0.1, 32);
            const base = new THREE.Mesh(baseGeom, cameraMat);
            const bodyGeom = new THREE.SphereGeometry(0.5, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2); 
            const body = new THREE.Mesh(bodyGeom, cameraMat);
            body.position.y = -0.05;
            cameraGroup.add(base);
            cameraGroup.add(body);
            cameraGroup.position.copy(position);
            scene.add(cameraGroup);
            sceneObjects.cameras.push(cameraGroup); // [NEW] ç®¡ç†ãƒªã‚¹ãƒˆã«è¿½åŠ 
            return cameraGroup;
        }

        // [NEW] éƒ¨å±‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
        function clearSceneObjects() {
            sceneObjects.desks.forEach(d => scene.remove(d));
            sceneObjects.chairs.forEach(c => scene.remove(c));
            sceneObjects.lights.forEach(l => scene.remove(l));
            sceneObjects.cameras.forEach(c => scene.remove(c));
            sceneObjects = { desks: [], chairs: [], lights: [], cameras: [] };
        }

        // [NEW] éƒ¨å±‹ã‚’æ§‹ç¯‰ã™ã‚‹
        function setupRoom(roomId) {
            currentRoomId = roomId;
            resetSimulation(false); // é¡§å®¢ã¨TWEENã‚’ãƒªã‚»ãƒƒãƒˆ (ã‚«ãƒ¡ãƒ©ã¯ãã®ã¾ã¾)
            clearSceneObjects(); // å¤ã„æœºã€æ¤…å­ã€ãƒ©ã‚¤ãƒˆã€ã‚«ãƒ¡ãƒ©ã‚’å‰Šé™¤

            const room = ROOM_DATA[roomId];
            
            // ç©ºå¸­é…åˆ—ã‚’ãƒªã‚»ãƒƒãƒˆ
            roomAvailableSeats[roomId].fill(true);
            
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ (æœºã¨æ¤…å­)
            room.seats.forEach(seat => {
                createChair(seat.chair, seat.rotation);
                createDesk(seat.desk, seat.rotation);
            });
            
            // ãƒ©ã‚¤ãƒˆã‚’ä½œæˆ
            room.lights.forEach(light => {
                const spotLight = new THREE.SpotLight(0xffffff, 0.8, 20, Math.PI / 4, 0.3, 1.0);
                spotLight.position.set(light.x, 8, light.z);
                spotLight.target.position.set(light.x, 0, light.z);
                spotLight.castShadow = true;
                spotLight.shadow.mapSize.width = 1024;
                spotLight.shadow.mapSize.height = 1024;
                scene.add(spotLight);
                scene.add(spotLight.target);
                sceneObjects.lights.push(spotLight);
                sceneObjects.lights.push(spotLight.target);
            });
            
            // ã‚«ãƒ¡ãƒ©ã‚’ä½œæˆ
            room.cameras.forEach(cam => {
                createSecurityCamera(new THREE.Vector3(cam.x, cam.y, cam.z));
            });

            // 2Dåº§å¸­è¡¨ã‚’å†æ§‹ç¯‰
            initSeatingChart(roomId);
        }

        /**
         * 2Dåº§å¸­è¡¨ã®UIã‚’æ›´æ–°ã™ã‚‹
         */
        function updateSeatingChart() {
            const seats = ROOM_DATA[currentRoomId].seats;
            for (let i = 0; i < seats.length; i++) {
                const seatEl = document.getElementById(`seat-${i}`);
                if (!seatEl) continue;

                if (roomAvailableSeats[currentRoomId][i]) {
                    seatEl.classList.remove('occupied');
                    seatEl.classList.add('empty');
                    seatEl.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${i} (ç©º)`;
                } else {
                    seatEl.classList.remove('empty');
                    seatEl.classList.add('occupied');
                    seatEl.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${i} (æº€)`;
                }
            }
        }

        /**
         * 2Dåº§å¸­è¡¨ã®HTMLã‚’åˆæœŸåŒ–ã™ã‚‹ (roomIdã§)
         */
        function initSeatingChart(roomId) {
            const room = ROOM_DATA[roomId];
            chartContainer.innerHTML = ''; // [NEW] ã¾ãšã‚¯ãƒªã‚¢
            chartContainer.style.gridTemplateColumns = `repeat(${room.chart_columns}, 1fr)`; // [NEW] ã‚«ãƒ©ãƒ æ•°ã‚’è¨­å®š

            room.chart_grid.forEach((seatId) => {
                const seatEl = document.createElement('div');
                if (seatId === -1) {
                    seatEl.className = 'seat-placeholder';
                } else {
                    seatEl.id = `seat-${seatId}`; // IDã¯ 0 ã‹ã‚‰å§‹ã¾ã‚‹
                    seatEl.className = 'seat';
                }
                chartContainer.appendChild(seatEl);
            });
            updateSeatingChart();
        }
        
        function updateReceptionUI(status) {
            // (ã“ã®é–¢æ•°ã¯ã‚‚ã†ä½¿ç”¨ã—ãªã„)
        }

        // ã‚·ãƒ¼ãƒ³ã®åˆæœŸåŒ–
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);
            scene.fog = new THREE.Fog(0xffffff, 15, 30);

            clock = new THREE.Clock();

            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 8, 10);
            camera.lookAt(0, 1, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // [MOD] éƒ¨å±‹ã«ä¾å­˜ã—ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿åˆæœŸåŒ–
            ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            ground = new THREE.Mesh(
                new THREE.PlaneGeometry(30, 30),
                new THREE.MeshStandardMaterial({ color: 0xeeeeee, roughness: 0.9 })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = FLOOR_Y;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // [NEW] éƒ¨å±‹ã‚»ãƒ¬ã‚¯ã‚¿ã‚’åˆæœŸåŒ–
            const roomOptions = Object.keys(ROOM_DATA).map(roomId => 
                `<option value="${roomId}">${ROOM_DATA[roomId].name}</option>`
            ).join('');
            roomSelector.innerHTML = roomOptions;
            reserveLocationSelect.innerHTML = roomOptions; // äºˆç´„ãƒšãƒ¼ã‚¸ã«ã‚‚è¨­å®š

            // [NEW] æœ€åˆã®éƒ¨å±‹ã‚’æ§‹ç¯‰
            setupRoom(currentRoomId);


            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enabled = true; 
            controls.update();

            const timestampEl = document.getElementById('timestamp');
            if (timestampEl) {
                const updateTimestamp = () => {
                    const now = new Date();
                    timestampEl.textContent = now.toLocaleTimeString('ja-JP');
                };
                updateTimestamp();
                setInterval(updateTimestamp, 1000);
            }

            // [MOD] ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            navHomeButton.addEventListener('click', showHomePage);
            navToolsButton.addEventListener('click', showToolsPage);
            navGameButton.addEventListener('click', showGamePage); 
            navReserveButton.addEventListener('click', showReservePage); // [NEW]

            // [NEW] ã‚²ãƒ¼ãƒ é¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            selectOthelloButton.addEventListener('click', showOthelloGame);
            selectJankenButton.addEventListener('click', showJankenGame);

            window.addEventListener('resize', onWindowResize);
            document.getElementById('startButton').addEventListener('click', startSimulation);
            document.getElementById('resetButton').addEventListener('click', () => resetSimulation(true)); // [MOD]
            
            // [NEW] éƒ¨å±‹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
            roomSelector.addEventListener('change', (e) => {
                setupRoom(e.target.value);
            });
            
            // [NEW] äºˆç´„ãƒœã‚¿ãƒ³ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
            reserveButton.addEventListener('click', () => {
                const reservation = {
                    location: reserveLocationSelect.value,
                    date: reserveDateInput.value,
                    time: reserveTimeInput.value
                };
                console.log("äºˆç´„ãŒè©¦è¡Œã•ã‚Œã¾ã—ãŸ:", reservation);
                // ã“ã“ã§äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¾‹: reservations.push(reservation)ï¼‰
                // ...
                // ç°¡å˜ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                alert("äºˆç´„ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸï¼ˆãƒ€ãƒŸãƒ¼ï¼‰");
            });

            showHomePage();
            animate();
        }

        /**
         * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
         */
        function startSimulation() {
            if (simulationState === 'RUNNING') return;
            simulationState = 'RUNNING';
            lastAssignmentTime = clock.getElapsedTime() * 1000; 

            customerQueue.forEach(c => c.remove());
            customerQueue = [];
            
            const room = ROOM_DATA[currentRoomId]; // [MOD]

            for (let i = 0; i < room.num_queue_robots; i++) { // [MOD]
                const customer = new Customer(scene);
                const qPos = new THREE.Vector3(
                    room.queue_start.x, // [MOD]
                    room.queue_start.y, // [MOD]
                    room.queue_start.z + (i * room.queue_spacing) // [MOD]
                );
                customer.spawnAtQueue(qPos);
                customerQueue.push(customer);
                allCustomers.push(customer);
            }
        }

        /**
         * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
         */
        function resetSimulation(resetCamera = true) { // [MOD]
            simulationState = 'IDLE';
            
            allCustomers.forEach(customer => customer.remove());
            allCustomers = [];
            customerQueue = [];
            
            TWEEN.removeAll();
            
            // [MOD] ç¾åœ¨ã®éƒ¨å±‹ã®ç©ºå¸­ã®ã¿ãƒªã‚»ãƒƒãƒˆ
            if (roomAvailableSeats[currentRoomId]) {
                roomAvailableSeats[currentRoomId].fill(true);
            }
            
            updateSeatingChart();

            if (resetCamera) { // [MOD]
                camera.position.set(0, 8, 10);
                controls.target.set(0, 1, 0);
                controls.update();
            }

            console.log("ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
        }

        /**
         * è¡Œåˆ—ã‚’å‰ã«è©°ã‚ã‚‹
         */
        function repositionQueue() {
            const room = ROOM_DATA[currentRoomId]; // [MOD]
            customerQueue.forEach((customer, i) => {
                const newPos = new THREE.Vector3(
                    room.queue_start.x, // [MOD]
                    room.queue_start.y, // [MOD]
                    room.queue_start.z + (i * room.queue_spacing) // [MOD]
                );
                customer.moveToQueuePosition(newPos);
            });
        }
        
        /**
         * ç©ºå¸­ã‚’æ¢ã™
         */
        function findAvailableSeat() {
            // [MOD]
            return roomAvailableSeats[currentRoomId].findIndex(isAvailable => isAvailable === true);
        }
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        function animate() {
            requestAnimationFrame(animate);

            const elapsedTime = clock.getElapsedTime();

            TWEEN.update();
            controls.update();

            allCustomers.forEach(customer => {
                customer.update(elapsedTime);
            });

            // è‡ªå‹•å‰²ã‚Šå½“ã¦ãƒ­ã‚¸ãƒƒã‚¯
            if (simulationState === 'RUNNING' && (elapsedTime * 1000) > lastAssignmentTime) {
                
                lastAssignmentTime = (elapsedTime * 1000) + ASSIGNMENT_INTERVAL_BASE + Math.random() * ASSIGNMENT_INTERVAL_RANDOM;
                
                const seatIndex = findAvailableSeat();
                
                if (seatIndex !== -1 && customerQueue.length > 0) {
                    const customer = customerQueue.shift();
                    repositionQueue();
                    
                    customer.seatIndex = seatIndex;
                    const seatInfo = ROOM_DATA[currentRoomId].seats[seatIndex]; // [MOD]
                    
                    customer.walkToSeat(seatInfo.walkTo, seatInfo.rotation, () => {
                        customer.sitDown(seatInfo.sitPoint, () => {
                            roomAvailableSeats[currentRoomId][seatIndex] = false; // [MOD]
                            updateSeatingChart();
                        });
                    });
                } else if (customerQueue.length > 0) {
                    // (æº€å¸­)
                }
            }
            
            const customersToRemove = allCustomers.filter(customer => customer.state === 'REMOVABLE');
            
            let removalCount = 0;
            customersToRemove.forEach(customer => {
                customer.remove(); 
                allCustomers = allCustomers.filter(c => c !== customer);
                removalCount++;
            });

            const room = ROOM_DATA[currentRoomId]; // [MOD]
            for (let i = 0; i < removalCount; i++) {
                // [MOD] ç¾åœ¨ã®éƒ¨å±‹ã®è¡Œåˆ—ãŒæœ€å¤§å€¤ã‚’è¶…ãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
                if (customerQueue.length >= room.num_queue_robots) break;
                
                const newCustomer = new Customer(scene);
                const qPos = new THREE.Vector3(
                    room.queue_start.x, // [MOD]
                    room.queue_start.y, // [MOD]
                    room.queue_start.z + (customerQueue.length * room.queue_spacing) // [MOD]
                );
                newCustomer.spawnAtQueue(qPos);
                customerQueue.push(newCustomer);
                allCustomers.push(newCustomer);
            }


            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            if (!container || container.clientWidth === 0 || container.clientHeight === 0) {
                return;
            }
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        // [MOD] è­¦å‘Šå›é¿
        // (window.alert ã‚’ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã«ç½®ãæ›ãˆã‚‹)
        function alert(message) {
            console.log("ALERT:", message);
            // æœ¬æ¥ã¯ã“ã“ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«UIã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
        }


        init();
    </script>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ2: ç”»åƒåº§å¸­åˆ†æã‚¢ãƒ—ãƒª (IDãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ã) -->
    <script type="module">
        // --- (ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å¤‰æ›´ãªã—) ---
        const uploadArea = document.getElementById('analyzer-uploadArea');
        const imageUpload = document.getElementById('analyzer-imageUpload');
        const imagePreviewContainer = document.getElementById('analyzer-imagePreviewContainer');
        const imagePreview = document.getElementById('analyzer-imagePreview');
        const seatButton = document.getElementById('analyzer-seatButton'); 
        const resetButton = document.getElementById('analyzer-resetButton'); 
        const resultContainer = document.getElementById('analyzer-resultContainer');
        const loadingIndicator = document.getElementById('analyzer-loadingIndicator');
        const errorDisplay = document.getElementById('analyzer-errorDisplay');
        const errorMessage = document.getElementById('analyzer-errorMessage');
        const resultDisplay = document.getElementById('analyzer-resultDisplay');
        const resultOccupied = document.getElementById('analyzer-resultOccupied');
        const resultEmpty = document.getElementById('analyzer-resultEmpty');
        const resultTotal = document.getElementById('analyzer-resultTotal');
        const rawJsonDisplayContainer = document.getElementById('analyzer-rawJsonDisplayContainer');
        const rawJsonDisplay = document.getElementById('analyzer-rawJsonDisplay');
        const buttonText = seatButton.querySelector('.buttonText');
        const buttonSpinner = seatButton.querySelector('.analyzer-spinner');
        const useSampleImageBtn = document.getElementById('use-sample-image'); // [NEW]
        let imageDataBase64 = null;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('border-purple-500', 'bg-purple-50'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('border-purple-500', 'bg-purple-50'), false);
        });
        uploadArea.addEventListener('drop', handleDrop, false);
        function handleDrop(e) {
            handleFiles(e.dataTransfer.files);
        }

        uploadArea.addEventListener('click', (e) => {
            // [MOD] ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’é–‹ã‹ãªã„
            if (e.target !== useSampleImageBtn) {
                imageUpload.click();
            }
        });
        imageUpload.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            const file = files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imageDataBase64 = e.target.result.split(',')[1];
                showPreview();
            };
            reader.readAsDataURL(file);
        }
        
        // [NEW] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢
        function showPreview() {
            uploadArea.classList.add('hidden');
            imagePreviewContainer.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            rawJsonDisplayContainer.classList.add('hidden');
        }

        // [NEW] ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚’ä½¿ç”¨
        useSampleImageBtn.addEventListener('click', async (e) => {
            e.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼‰ã‚’é˜²æ­¢
            try {
                // [MOD] ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ç”»åƒURLã«å¤‰æ›´ -> ã‚¨ãƒ©ãƒ¼ã®ãŸã‚Unsplashã«æˆ»ã™
                const imageUrl = 'https://images.unsplash.com/photo-1589884629102-319a5898ae96?w=800&q=80'; 
                
                // CORSå›é¿ã®ãŸã‚ã®ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã™ã‚‹ä¾‹ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰ã‚‚ã‚ã‚Šã¾ã™ãŒã€
                // ã“ã“ã§ã¯ç›´æ¥fetchã‚’è©¦ã¿ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                const response = await fetch(imageUrl, { mode: 'cors' }); 
                if (!response.ok) throw new Error('Network response was not ok');
                const blob = await response.blob();
                
                // Blobã‚’Base64ã«å¤‰æ›ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imageDataBase64 = e.target.result.split(',')[1];
                    showPreview();
                };
                reader.readAsDataURL(blob);
            } catch (error) {
                console.error("ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                alert("ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n(CORSåˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç”»åƒã‚’ä¿å­˜ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„)");
            }
        });

        resetButton.addEventListener('click', () => {
            imageDataBase64 = null;
            imageUpload.value = null;
            uploadArea.classList.remove('hidden');
            imagePreviewContainer.classList.add('hidden');
            resultContainer.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            rawJsonDisplayContainer.classList.add('hidden');
            setLoading(false);
        });

        const seatAnalysisPrompt = `
        ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹ã€Œæ¤…å­ã€ã¨ã€Œäººã€ã‚’èªè­˜ã—ã¦ãã ã•ã„ã€‚
        - "total_chairs": ç”»åƒã«å†™ã£ã¦ã„ã‚‹æ¤…å­ã®ç·æ•° (äººãŒåº§ã£ã¦ã„ã‚‹æ¤…å­ã‚‚å«ã‚€)
        - "occupied_seats": äººãŒåº§ã£ã¦ã„ã‚‹æ¤…å­ã®æ•°
        - "empty_seats": èª°ã‚‚åº§ã£ã¦ã„ãªã„ç©ºå¸­ã®æ•°
        ä¸Šè¨˜ã®3ã¤ã®ã‚­ãƒ¼ã‚’æŒã¤JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚
        `;
        const responseSchema = {
            type: "OBJECT",
            properties: {
                "total_chairs": { "type": "NUMBER" },
                "occupied_seats": { "type": "NUMBER" },
                "empty_seats": { "type": "NUMBER" }
            },
            required: ["total_chairs", "occupied_seats", "empty_seats"]
        };

        seatButton.addEventListener('click', () => {
            if (!imageDataBase64) {
                showError('ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            callGeminiAPI(imageDataBase64, seatAnalysisPrompt, responseSchema);
        });
        
        function setLoading(isLoading) {
            seatButton.disabled = isLoading;
            resetButton.disabled = isLoading;
            if(isLoading) {
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');
            } else {
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
            }
        }

        function showError(message) {
            console.error(message);
            resultContainer.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
            resultDisplay.classList.add('hidden');
            rawJsonDisplayContainer.classList.add('hidden');
            errorDisplay.classList.remove('hidden');
            errorMessage.textContent = message;
        }
        
        async function callGeminiAPI(base64ImageData, prompt, schema) {
            setLoading(true);
            resultContainer.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            resultDisplay.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            rawJsonDisplayContainer.classList.add('hidden');

            // [MOD] APIã‚­ãƒ¼å…¥åŠ›ç®‡æ‰€
            const apiKey = "AIzaSyAUY_MHVDoprNWHe6hQ4kd3fsgyE9KUWjc"; // â˜…â˜…â˜…ã“ã“ã«Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â˜…â˜…â˜…
            // ä¾‹: const apiKey = "AIzaSyD......";
            
            if (!apiKey) {
                showError("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® `const apiKey` ã«ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                setLoading(false);
                return;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                },
                safetySettings: [
                    { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                    { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                ]
            };
            
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        if (response.status === 429) throw new Error('Rate limit exceeded (429)');
                        const errorData = await response.json();
                        throw new Error(`API Error ${response.status}: ${errorData.error?.message || response.statusText}`);
                    }
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const text = candidate?.content?.parts?.[0]?.text;
                    if (candidate?.finishReason === 'SAFETY') {
                        throw new Error("ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®‰å…¨æ€§è¨­å®šã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚");
                    }
                    if (text) {
                        loadingIndicator.classList.add('hidden');
                        try {
                            const data = JSON.parse(text);
                            rawJsonDisplay.textContent = JSON.stringify(data, null, 2);
                            rawJsonDisplayContainer.classList.remove('hidden');
                            if (data.total_chairs !== undefined && data.occupied_seats !== undefined && data.empty_seats !== undefined) {
                                resultOccupied.textContent = data.occupied_seats;
                                resultEmpty.textContent = data.empty_seats;
                                resultTotal.textContent = data.total_chairs;
                                resultDisplay.classList.remove('hidden'); 
                            } else {
                                throw new Error("JSONã«å¿…è¦ãªã‚­ãƒ¼ (total_chairs, occupied_seats, empty_seats) ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                            }
                        } catch (parseError) {
                            throw new Error(`APIãŒæœ‰åŠ¹ãªJSONã‚’è¿”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚ [${parseError.name}] ${parseError.message} (å¿œç­”: ${text.substring(0, 100)}...)`);
                        }
                    } else {
                        throw new Error("APIã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
                    }
                    setLoading(false);
                    return;
                } catch (error) {
                    console.warn(`Attempt ${attempts + 1} failed: ${error.message}`);
                    attempts++;
                    if (attempts >= maxAttempts) {
                        showError(`åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: [${error.name}] ${error.message}`);
                        setLoading(false);
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
        }
    </script>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ3: ã‚ªã‚»ãƒ­ã‚²ãƒ¼ãƒ  -->
    <script>
        // (ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ç½®ããŸã‚ã€type="module" ã§ã¯ãªãã™ã‚‹)
        
        const othelloBoardElement = document.getElementById('othello-board');
        const othelloPlayerScoreElement = document.getElementById('othello-player-score');
        const othelloAiScoreElement = document.getElementById('othello-ai-score');
        const othelloTurnIndicatorElement = document.getElementById('othello-turn-indicator');
        const othelloResetButton = document.getElementById('othello-reset-button');

        const OTHELLO_PLAYER = 1; // Black
        const OTHELLO_AI = 2;     // White
        const OTHELLO_EMPTY = 0;
        const OTHELLO_BOARD_SIZE = 8;
        const OTHELLO_AI_SEARCH_DEPTH = 5; 

        let othelloBoard = [];
        let othelloCurrentPlayer;
        let othelloGameOver = false;

        const OTHELLO_PST = [
            [120, -20, 20, 5, 5, 20, -20, 120],
            [-20, -40, -5, -5, -5, -5, -40, -20],
            [20, -5, 15, 3, 3, 15, -5, 20],
            [5, -5, 3, 3, 3, 3, -5, 5],
            [5, -5, 3, 3, 3, 3, -5, 5],
            [20, -5, 15, 3, 3, 15, -5, 20],
            [-20, -40, -5, -5, -5, -5, -40, -20],
            [120, -20, 20, 5, 5, 20, -20, 120]
        ];

        function othelloInit() {
            othelloBoard = Array(OTHELLO_BOARD_SIZE).fill(0).map(() => Array(OTHELLO_BOARD_SIZE).fill(OTHELLO_EMPTY));
            othelloBoard[3][3] = OTHELLO_AI;
            othelloBoard[3][4] = OTHELLO_PLAYER;
            othelloBoard[4][3] = OTHELLO_PLAYER;
            othelloBoard[4][4] = OTHELLO_AI;
            
            othelloCurrentPlayer = OTHELLO_PLAYER;
            othelloGameOver = false;
            othelloRenderBoard();
            othelloUpdateTurnIndicator();
        }

        function othelloRenderBoard() {
            othelloBoardElement.innerHTML = '';
            const validMoves = othelloGetValidMoves(othelloCurrentPlayer);

            for (let r = 0; r < OTHELLO_BOARD_SIZE; r++) {
                for (let c = 0; c < OTHELLO_BOARD_SIZE; c++) {
                    const square = document.createElement('div');
                    square.className = 'othello-square'; 
                    square.dataset.r = r;
                    square.dataset.c = c;

                    const discValue = othelloBoard[r][c];
                    if (discValue !== OTHELLO_EMPTY) {
                        const disc = document.createElement('div');
                        disc.className = 'othello-disc'; 
                        
                        const inner = document.createElement('div');
                        inner.className = 'othello-disc-inner othello-disc-front'; 
                        
                        const inner_back = document.createElement('div');
                        inner_back.className = 'othello-disc-inner othello-disc-back'; 
                        
                        disc.appendChild(inner);
                        disc.appendChild(inner_back);

                        disc.classList.add(discValue === OTHELLO_PLAYER ? 'black' : 'white');
                        square.appendChild(disc);
                    } else if (othelloCurrentPlayer === OTHELLO_PLAYER && validMoves.some(m => m.r === r && m.c === c)) {
                        const indicator = document.createElement('div');
                        indicator.className = 'othello-valid-move-indicator'; 
                        square.appendChild(indicator);
                    }
                    
                    othelloBoardElement.appendChild(square);
                }
            }
            othelloUpdateScores();
        }

        function othelloUpdateScores() {
            let pScore = 0;
            let aScore = 0;
            for (let r = 0; r < OTHELLO_BOARD_SIZE; r++) {
                for (let c = 0; c < OTHELLO_BOARD_SIZE; c++) {
                    if (othelloBoard[r][c] === OTHELLO_PLAYER) pScore++;
                    else if (othelloBoard[r][c] === OTHELLO_AI) aScore++;
                }
            }
            othelloPlayerScoreElement.textContent = pScore;
            othelloAiScoreElement.textContent = aScore;
        }
        
        function othelloUpdateTurnIndicator() {
            if(othelloGameOver) return;
            if(othelloCurrentPlayer === OTHELLO_PLAYER) {
                othelloTurnIndicatorElement.textContent = 'ã‚ãªãŸã®ç•ª';
                othelloTurnIndicatorElement.className = 'text-lg font-semibold px-4 py-2 rounded-md bg-blue-500 text-white';
            } else {
                othelloTurnIndicatorElement.textContent = 'AI è€ƒãˆä¸­...';
                othelloTurnIndicatorElement.className = 'text-lg font-semibold px-4 py-2 rounded-md bg-red-500 text-white';
            }
        }

        function othelloGetFlips(r, c, player, currentBoard) {
            const opponent = player === OTHELLO_PLAYER ? OTHELLO_AI : OTHELLO_PLAYER;
            const directions = [[-1, -1], [-1, 0], [-1, 1], [0, -1], [0, 1], [1, -1], [1, 0], [1, 1]];
            let allFlips = [];

            if (currentBoard[r][c] !== OTHELLO_EMPTY) return [];

            for (const [dr, dc] of directions) {
                let line = [];
                let cr = r + dr;
                let cc = c + dc;

                while (cr >= 0 && cr < OTHELLO_BOARD_SIZE && cc >= 0 && cc < OTHELLO_BOARD_SIZE && currentBoard[cr][cc] === opponent) {
                    line.push({ r: cr, c: cc });
                    cr += dr;
                    cc += dc;
                }

                if (cr >= 0 && cr < OTHELLO_BOARD_SIZE && cc >= 0 && cc < OTHELLO_BOARD_SIZE && currentBoard[cr][cc] === player) {
                    allFlips = allFlips.concat(line);
                }
            }
            return allFlips;
        }

        function othelloGetValidMoves(player, currentBoard = othelloBoard) {
            const moves = [];
            for (let r = 0; r < OTHELLO_BOARD_SIZE; r++) {
                for (let c = 0; c < OTHELLO_BOARD_SIZE; c++) {
                    if (currentBoard[r][c] === OTHELLO_EMPTY) {
                        if (othelloGetFlips(r, c, player, currentBoard).length > 0) {
                            moves.push({ r, c });
                        }
                    }
                }
            }
            return moves;
        }

        async function othelloMakeMove(r, c, player) {
            if (othelloGameOver) return;
            const flips = othelloGetFlips(r, c, player, othelloBoard);
            if (flips.length === 0) return;

            othelloBoard[r][c] = player;
            
            const square = othelloBoardElement.querySelector(`[data-r='${r}'][data-c='${c}']`);
            if (square.firstChild) square.removeChild(square.firstChild); 

            const disc = document.createElement('div');
            disc.className = 'othello-disc';
            const inner = document.createElement('div'); inner.className = 'othello-disc-inner othello-disc-front';
            const inner_back = document.createElement('div'); inner_back.className = 'othello-disc-inner othello-disc-back';
            disc.appendChild(inner); disc.appendChild(inner_back);
            square.appendChild(disc);

            disc.style.transform = 'scale(0)';
            await new Promise(res => setTimeout(res, 50));
            disc.style.transition = 'transform 0.3s';
            disc.classList.add(player === OTHELLO_PLAYER ? 'black' : 'white');
            disc.style.transform = 'scale(1)';

            for (const f of flips) {
                othelloBoard[f.r][f.c] = player;
            }

            setTimeout(() => {
                for (const f of flips) {
                   const flipSquare = othelloBoardElement.querySelector(`[data-r='${f.r}'][data-c='${f.c}']`);
                   if (flipSquare && flipSquare.firstChild) {
                       const discToFlip = flipSquare.firstChild;
                       discToFlip.classList.toggle('black');
                       discToFlip.classList.toggle('white');
                   }
                }
                othelloUpdateScores();
                othelloSwitchTurn();
            }, 300);
        }
        
        function othelloSwitchTurn() {
            othelloCurrentPlayer = othelloCurrentPlayer === OTHELLO_PLAYER ? OTHELLO_AI : OTHELLO_PLAYER;
            let validMoves = othelloGetValidMoves(othelloCurrentPlayer);

            if (validMoves.length === 0) {
                othelloCurrentPlayer = othelloCurrentPlayer === OTHELLO_PLAYER ? OTHELLO_AI : OTHELLO_PLAYER;
                validMoves = othelloGetValidMoves(othelloCurrentPlayer);
                if (validMoves.length === 0) {
                    othelloEndGame();
                    return;
                }
            }
            
            othelloUpdateTurnIndicator();
            if(othelloCurrentPlayer === OTHELLO_PLAYER) {
                othelloRenderBoard(); 
            }

            if (!othelloGameOver && othelloCurrentPlayer === OTHELLO_AI) {
                setTimeout(othelloMakeAiMove, 500);
            }
        }
        
        function othelloEndGame() {
            othelloGameOver = true;
            let pScore = 0, aScore = 0;
            othelloBoard.flat().forEach(cell => {
                if (cell === OTHELLO_PLAYER) pScore++;
                if (cell === OTHELLO_AI) aScore++;
            });
            
            if (pScore > aScore) {
                othelloTurnIndicatorElement.textContent = 'ã‚ãªãŸã®å‹ã¡ï¼';
                othelloTurnIndicatorElement.className = 'text-lg font-semibold px-4 py-2 rounded-md bg-green-500 text-white';
            } else if (aScore > pScore) {
                othelloTurnIndicatorElement.textContent = 'AIã®å‹ã¡';
                othelloTurnIndicatorElement.className = 'text-lg font-semibold px-4 py-2 rounded-md bg-yellow-500 text-black';
            } else {
                othelloTurnIndicatorElement.textContent = 'å¼•ãåˆ†ã‘';
                othelloTurnIndicatorElement.className = 'text-lg font-semibold px-4 py-2 rounded-md bg-gray-500 text-white';
            }
        }

        othelloBoardElement.addEventListener('click', (e) => {
            if (othelloCurrentPlayer !== OTHELLO_PLAYER || othelloGameOver) return;
            const square = e.target.closest('.othello-square');
            if (square && square.querySelector('.othello-valid-move-indicator')) {
                const r = parseInt(square.dataset.r);
                const c = parseInt(square.dataset.c);
                othelloMakeMove(r, c, OTHELLO_PLAYER);
            }
        });

        // --- AI LOGIC (å…¨ã¦ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãã«å¤‰æ›´) ---
        function othelloMakeAiMove() {
            const bestMove = othelloFindBestMove();
            if (bestMove) {
                othelloMakeMove(bestMove.r, bestMove.c, OTHELLO_AI);
            }
        }

        function othelloFindBestMove() {
            let bestScore = -Infinity;
            let move = null;
            const validMoves = othelloGetValidMoves(OTHELLO_AI, othelloBoard);

            for (const m of validMoves) {
                const tempBoard = JSON.parse(JSON.stringify(othelloBoard));
                othelloApplyMoveToBoard(tempBoard, m.r, m.c, OTHELLO_AI);
                const score = othelloMinimax(tempBoard, OTHELLO_AI_SEARCH_DEPTH, -Infinity, Infinity, false);
                if (score > bestScore) {
                    bestScore = score;
                    move = m;
                }
            }
            return move;
        }

        function othelloMinimax(currentBoard, depth, alpha, beta, isMaximizing) {
            if (depth === 0) {
                 return othelloEvaluateBoard(currentBoard);
            }

            const player = isMaximizing ? OTHELLO_AI : OTHELLO_PLAYER;
            const validMoves = othelloGetValidMoves(player, currentBoard);
            
            if (validMoves.length === 0) {
                const otherPlayer = player === OTHELLO_AI ? OTHELLO_PLAYER : OTHELLO_AI;
                const otherValidMoves = othelloGetValidMoves(otherPlayer, currentBoard);
                if (otherValidMoves.length === 0) {
                    return othelloEvaluateBoard(currentBoard);
                }
                return othelloMinimax(currentBoard, depth - 1, alpha, beta, !isMaximizing);
            }

            if (isMaximizing) {
                let maxEval = -Infinity;
                for (const move of validMoves) {
                    const childBoard = JSON.parse(JSON.stringify(currentBoard));
                    othelloApplyMoveToBoard(childBoard, move.r, move.c, player);
                    const evaluation = othelloMinimax(childBoard, depth - 1, alpha, beta, false);
                    maxEval = Math.max(maxEval, evaluation);
                    alpha = Math.max(alpha, evaluation);
                    if (beta <= alpha) break;
                }
                return maxEval;
            } else { // Minimizing
                let minEval = Infinity;
                for (const move of validMoves) {
                    const childBoard = JSON.parse(JSON.stringify(currentBoard));
                    othelloApplyMoveToBoard(childBoard, move.r, move.c, player);
                    const evaluation = othelloMinimax(childBoard, depth - 1, alpha, beta, true);
                    minEval = Math.min(minEval, evaluation);
                    beta = Math.min(beta, evaluation);
                    if (beta <= alpha) break;
                }
                return minEval;
            }
        }

        function othelloApplyMoveToBoard(b, r, c, player) {
            const flips = othelloGetFlips(r, c, player, b);
            b[r][c] = player;
            for (const f of flips) {
                b[f.r][f.c] = player;
            }
        }

        function othelloEvaluateBoard(currentBoard) {
            let score = 0;
            let aiPieces = 0;
            let playerPieces = 0;

            for (let r = 0; r < OTHELLO_BOARD_SIZE; r++) {
                for (let c = 0; c < OTHELLO_BOARD_SIZE; c++) {
                    if (currentBoard[r][c] === OTHELLO_AI) {
                        aiPieces++;
                        score += OTHELLO_PST[r][c];
                    } else if (currentBoard[r][c] === OTHELLO_PLAYER) {
                        playerPieces++;
                        score -= OTHELLO_PST[r][c];
                    }
                }
            }
            
            score += (aiPieces - playerPieces) * 10;

            const aiMoves = othelloGetValidMoves(OTHELLO_AI, currentBoard).length;
            const playerMoves = othelloGetValidMoves(OTHELLO_PLAYER, currentBoard).length;
            score += (aiMoves - playerMoves) * 20;

            return score;
        }

        othelloResetButton.addEventListener('click', othelloInit);
        
        othelloInit();
    </script>
    
    <!-- [NEW] ã‚¹ã‚¯ãƒªãƒ—ãƒˆ4: ã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ  -->
    <script>
        const jankenRockButton = document.getElementById('janken-rock');
        const jankenScissorsButton = document.getElementById('janken-scissors');
        const jankenPaperButton = document.getElementById('janken-paper');
        const jankenAiHand = document.getElementById('janken-ai-hand');
        const jankenResult = document.getElementById('janken-result');
        
        // [NEW] ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        const jankenCouponModal = document.getElementById('janken-coupon-modal');
        const jankenCouponCloseButton = document.getElementById('janken-coupon-close-button');
        const confettiContainer = document.getElementById('confetti-container');

        const HANDS = ['âœŠ', 'âœŒï¸', 'âœ‹']; // 0: ã‚°ãƒ¼, 1: ãƒãƒ§ã‚­, 2: ãƒ‘ãƒ¼
        const HAND_NAMES = { 'âœŠ': 'ã‚°ãƒ¼', 'âœŒï¸': 'ãƒãƒ§ã‚­', 'âœ‹': 'ãƒ‘ãƒ¼' };
        
        // [NEW] æ¼”å‡ºä¸­ã®ãƒ•ãƒ©ã‚°
        let isPlaying = false;
        
        jankenRockButton.addEventListener('click', () => playGame(0));
        jankenScissorsButton.addEventListener('click', () => playGame(1));
        jankenPaperButton.addEventListener('click', () => playGame(2));
        jankenCouponCloseButton.addEventListener('click', hideCouponModal);

        // [MOD] ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ¼”å‡ºè¾¼ã¿ã§å¤‰æ›´
        async function playGame(playerHandIndex) {
            if (isPlaying) return; // æ¼”å‡ºä¸­ã¯å¤šé‡æŠ¼ã—ã‚’é˜²ã
            isPlaying = true;

            // 1. UIã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            jankenResult.textContent = '...';
            jankenResult.className = '';
            jankenAiHand.textContent = '?';
            jankenAiHand.classList.add('roulette');
            setButtonsDisabled(true);

            // 2. ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡º
            const rouletteInterval = setInterval(() => {
                const randomHand = HANDS[Math.floor(Math.random() * 3)];
                jankenAiHand.textContent = randomHand;
            }, 100);

            // 1.5ç§’å¾…æ©Ÿ
            await new Promise(resolve => setTimeout(resolve, 1500));

            // 3. ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆåœæ­¢ã¨çµæœåˆ¤å®š
            clearInterval(rouletteInterval);
            jankenAiHand.classList.remove('roulette');

            const aiHandIndex = Math.floor(Math.random() * 3);
            const aiHand = HANDS[aiHandIndex];
            jankenAiHand.textContent = aiHand;
            
            // å‹æ•—åˆ¤å®š (0: ã‚ã„ã“, 1: è² ã‘, 2: å‹ã¡)
            const result = (playerHandIndex - aiHandIndex + 3) % 3;
            
            if (result === 0) {
                jankenResult.textContent = 'ã‚ã„ã“ï¼';
                jankenResult.classList.add('draw');
            } else if (result === 2) {
                jankenResult.textContent = 'ã‚ãªãŸã®å‹ã¡ï¼';
                jankenResult.classList.add('win');
            } else {
                jankenResult.textContent = 'ã‚ãªãŸã®è² ã‘...';
                jankenResult.classList.add('lose');
            }

            // 4. å‹åˆ©æ¼”å‡º (å‹åˆ©ã—ãŸå ´åˆ)
            if (result === 2) {
                // 1ç§’å¾…ã£ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                await new Promise(resolve => setTimeout(resolve, 1000));
                showCouponModal();
            }

            // 5. ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
            setButtonsDisabled(false);
            isPlaying = false;
        }

        function setButtonsDisabled(disabled) {
            jankenRockButton.disabled = disabled;
            jankenScissorsButton.disabled = disabled;
            jankenPaperButton.disabled = disabled;
        }
        
        // [NEW] ã‚¯ãƒ¼ãƒãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showCouponModal() {
            jankenCouponModal.classList.remove('page-hidden');
            createConfetti(); // ç´™å¹é›ªã‚’ç”Ÿæˆ
        }

        // [NEW] ã‚¯ãƒ¼ãƒãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hideCouponModal() {
            jankenCouponModal.classList.add('page-hidden');
            confettiContainer.innerHTML = ''; // ç´™å¹é›ªã‚’å‰Šé™¤
        }

        // [NEW] ç´™å¹é›ªã‚’ç”Ÿæˆã™ã‚‹
        function createConfetti() {
            confettiContainer.innerHTML = ''; // å¤ã„ç´™å¹é›ªã‚’ã‚¯ãƒªã‚¢
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 3}s`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.opacity = Math.random() + 0.3;
                confettiContainer.appendChild(confetti);
            }
        }
    </script>
</body>
</html>
